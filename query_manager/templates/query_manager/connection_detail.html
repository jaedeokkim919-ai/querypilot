{% extends 'query_manager/base.html' %}

{% block title %}{{ connection.name }} - QueryPilot{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'query_manager:connection_list' %}">DB 연결</a></li>
                <li class="breadcrumb-item active">{{ connection.name }}</li>
            </ol>
        </nav>
        <h2><i class="bi bi-plug"></i> {{ connection.name }}</h2>
        <p class="text-muted">{{ connection.host }}:{{ connection.port }}{% if connection.database %}/{{ connection.database }}{% endif %}</p>
    </div>
    <div class="col-auto">
        <div class="btn-group">
            <a href="{% url 'query_manager:query_editor' %}?connection={{ connection.pk }}" class="btn btn-primary">
                <i class="bi bi-play"></i> 쿼리 실행
            </a>
            <button type="button" id="btn-test-connection" class="btn btn-outline-secondary">
                <i class="bi bi-plug"></i> 연결 테스트
            </button>
            <a href="{% url 'query_manager:connection_edit' connection.pk %}" class="btn btn-outline-secondary">
                <i class="bi bi-pencil"></i> 수정
            </a>
            <a href="{% url 'query_manager:connection_delete' connection.pk %}" class="btn btn-outline-danger">
                <i class="bi bi-trash"></i> 삭제
            </a>
        </div>
    </div>
</div>

<!-- Connection Status -->
<div id="connection-status" class="mb-4"></div>

<div class="row">
    <!-- Connection Info -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> 연결 정보</h6>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless">
                    <tr>
                        <th>호스트</th>
                        <td>{{ connection.host }}</td>
                    </tr>
                    <tr>
                        <th>포트</th>
                        <td>{{ connection.port }}</td>
                    </tr>
                    <tr>
                        <th>데이터베이스</th>
                        <td>{{ connection.database|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>사용자</th>
                        <td>{{ connection.username }}</td>
                    </tr>
                    <tr>
                        <th>상태</th>
                        <td>
                            {% if connection.is_active %}
                                <span class="badge bg-success">활성</span>
                            {% else %}
                                <span class="badge bg-secondary">비활성</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>생성일</th>
                        <td>{{ connection.created_at|date:"Y-m-d H:i" }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-bar-chart"></i> 통계</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h3>{{ connection.query_executions.count }}</h3>
                        <small class="text-muted">총 쿼리</small>
                    </div>
                    <div class="col-6">
                        <h3>{{ connection.schema_versions.count }}</h3>
                        <small class="text-muted">스키마 버전</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Queries -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-clock-history"></i> 최근 쿼리</h6>
                <a href="{% url 'query_manager:history_list' %}?connection={{ connection.pk }}" class="btn btn-sm btn-outline-secondary">
                    전체 보기
                </a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>쿼리</th>
                                <th>유형</th>
                                <th>상태</th>
                                <th>시간</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for q in recent_queries %}
                                <tr>
                                    <td>
                                        <a href="{% url 'query_manager:history_detail' q.pk %}" class="text-decoration-none">
                                            <code class="text-truncate d-inline-block" style="max-width: 300px;">
                                                {{ q.query_text|truncatechars:50 }}
                                            </code>
                                        </a>
                                    </td>
                                    <td><span class="badge bg-secondary">{{ q.query_type }}</span></td>
                                    <td>
                                        {% if q.status == 'SUCCESS' %}
                                            <span class="badge bg-success">성공</span>
                                        {% else %}
                                            <span class="badge bg-danger">실패</span>
                                        {% endif %}
                                    </td>
                                    <td><small>{{ q.executed_at|date:"m/d H:i" }}</small></td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">실행된 쿼리가 없습니다.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Schema Versions -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-file-earmark-code"></i> 스키마 버전</h6>
                <a href="{% url 'query_manager:schema_version_list' connection.pk %}" class="btn btn-sm btn-outline-secondary">
                    전체 보기
                </a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>테이블</th>
                                <th>버전</th>
                                <th>생성일</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sv in schema_versions %}
                                <tr>
                                    <td><code>{{ sv.table_name }}</code></td>
                                    <td><span class="badge bg-info">v{{ sv.version }}</span></td>
                                    <td><small>{{ sv.created_at|date:"Y-m-d H:i" }}</small></td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-4">저장된 스키마가 없습니다.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('btn-test-connection').addEventListener('click', function() {
    const statusDiv = document.getElementById('connection-status');
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> 연결 테스트 중...</div>';

    fetch('/api/connections/{{ connection.pk }}/test/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> <strong>연결 성공!</strong>
                    <p class="mb-0 mt-2">서버 버전: ${data.server_info.version}</p>
                </div>
            `;
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> <strong>연결 실패</strong>
                    <p class="mb-0 mt-2">${data.message}</p>
                </div>
            `;
        }
    });
});
</script>
{% endblock %}
