{% extends 'query_manager/base.html' %}

{% block title %}실행 이력 - QueryPilot{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-clock-history"></i> 쿼리 실행 이력</h2>
    </div>
</div>

<!-- Filter Form -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-2">
                <label class="form-label">연결</label>
                {{ form.connection }}
            </div>
            <div class="col-md-2">
                <label class="form-label">카테고리</label>
                {{ form.category }}
            </div>
            <div class="col-md-2">
                <label class="form-label">쿼리 유형</label>
                {{ form.query_type }}
            </div>
            <div class="col-md-2">
                <label class="form-label">상태</label>
                {{ form.status }}
            </div>
            <div class="col-md-2">
                <label class="form-label">시작일</label>
                {{ form.date_from }}
            </div>
            <div class="col-md-2">
                <label class="form-label">종료일</label>
                {{ form.date_to }}
            </div>
            <div class="col-md-2">
                <label class="form-label">작업자</label>
                {{ form.operator }}
            </div>
            <div class="col-md-2">
                <label class="form-label">검색</label>
                {{ form.search }}
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-search"></i> 검색
                </button>
                <a href="{% url 'query_manager:history_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg"></i> 초기화
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Results -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>검색 결과</span>
        <span class="badge bg-secondary">{{ executions.paginator.count }}건</span>
    </div>
    <div class="card-body p-0">
        {% if executions %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>연결</th>
                            <th>쿼리</th>
                            <th>유형</th>
                            <th>상태</th>
                            <th>작업자</th>
                            <th>영향 행</th>
                            <th>실행 시간</th>
                            <th>실행일</th>
                            <th>액션</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for e in executions %}
                            <tr>
                                <td>
                                    <a href="{% url 'query_manager:history_detail' e.pk %}">#{{ e.pk }}</a>
                                </td>
                                <td>
                                    <small>{{ e.connection.name }}</small>
                                </td>
                                <td>
                                    <a href="{% url 'query_manager:history_detail' e.pk %}" class="text-decoration-none">
                                        <code class="text-truncate d-inline-block" style="max-width: 250px;">
                                            {{ e.query_text|truncatechars:40 }}
                                        </code>
                                    </a>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ e.query_type }}</span>
                                </td>
                                <td>
                                    {% if e.status == 'SUCCESS' %}
                                        <span class="badge bg-success">성공</span>
                                    {% else %}
                                        <span class="badge bg-danger">실패</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if e.operator %}
                                        <small class="text-primary">{{ e.operator }}</small>
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                </td>
                                <td>{{ e.affected_rows|default:"-" }}</td>
                                <td>{{ e.execution_time|floatformat:3 }}s</td>
                                <td>
                                    <small>{{ e.executed_at|date:"Y-m-d H:i:s" }}</small>
                                </td>
                                <td>
                                    {% if e.query_type == 'DDL' and e.status == 'SUCCESS' %}
                                        <button type="button" class="btn btn-sm btn-outline-info btn-schema-compare"
                                                data-history-id="{{ e.pk }}"
                                                data-bs-toggle="modal" data-bs-target="#schemaCompareModal">
                                            <i class="bi bi-arrow-left-right"></i> 전/후 비교
                                        </button>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if executions.has_other_pages %}
                <nav class="p-3">
                    <ul class="pagination mb-0 justify-content-center">
                        {% if executions.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ executions.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">&laquo;</a>
                            </li>
                        {% endif %}

                        {% for num in executions.paginator.page_range %}
                            {% if executions.number == num %}
                                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                            {% elif num > executions.number|add:'-5' and num < executions.number|add:'5' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if executions.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ executions.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">&raquo;</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-clock-history display-1 text-muted"></i>
                <p class="text-muted mt-3">실행 이력이 없습니다.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Schema Compare Modal -->
<div class="modal fade" id="schemaCompareModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-arrow-left-right"></i> 스키마 전/후 비교</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="compareLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">비교 데이터를 불러오는 중...</p>
                </div>
                <div id="compareContent" style="display: none;">
                    <div class="mb-3">
                        <strong>테이블:</strong> <span id="compareTableName" class="badge bg-primary"></span>
                        <strong class="ms-3">실행 시간:</strong> <span id="compareExecutedAt" class="text-muted"></span>
                        <strong class="ms-3">실행 쿼리:</strong> <code id="compareQuery" class="text-truncate d-inline-block" style="max-width: 300px;"></code>
                    </div>

                    <!-- Side-by-Side View -->
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabSideBySide">
                                <i class="bi bi-layout-split"></i> 비교 보기
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabDiff">
                                <i class="bi bi-file-diff"></i> DIFF
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content border border-top-0 rounded-bottom">
                        <div class="tab-pane fade show active" id="tabSideBySide">
                            <div class="row g-0">
                                <div class="col-6 border-end">
                                    <div class="p-2 bg-danger bg-opacity-10 border-bottom">
                                        <strong><i class="bi bi-clock-history"></i> BEFORE (실행 전)</strong>
                                    </div>
                                    <pre id="schemaBefore" class="p-3 m-0" style="max-height: 400px; overflow: auto; font-size: 12px;"></pre>
                                </div>
                                <div class="col-6">
                                    <div class="p-2 bg-success bg-opacity-10 border-bottom">
                                        <strong><i class="bi bi-clock"></i> AFTER (실행 후)</strong>
                                    </div>
                                    <pre id="schemaAfter" class="p-3 m-0" style="max-height: 400px; overflow: auto; font-size: 12px;"></pre>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="tabDiff">
                            <pre id="schemaDiff" class="p-3 m-0 rounded-bottom" style="max-height: 400px; overflow: auto; background: #1e1e1e; color: #d4d4d4; font-size: 12px;"></pre>
                        </div>
                    </div>
                </div>
                <div id="compareError" class="alert alert-danger" style="display: none;"></div>
                <div id="compareNoData" class="alert alert-warning" style="display: none;">
                    <i class="bi bi-info-circle"></i> 이 DDL 실행에 대한 스키마 정보가 없습니다.
                    <br><small class="text-muted">이전 버전에서 실행된 쿼리이거나, 테이블이 생성/삭제되어 스키마를 조회할 수 없습니다.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .diff-added {
        background-color: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }
    .diff-removed {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }
    .diff-context {
        color: #6c757d;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Schema compare button handler
    document.querySelectorAll('.btn-schema-compare').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const historyId = this.dataset.historyId;
            loadSchemaComparison(historyId);
        });
    });

    function loadSchemaComparison(historyId) {
        // Reset modal state
        document.getElementById('compareLoading').style.display = 'block';
        document.getElementById('compareContent').style.display = 'none';
        document.getElementById('compareError').style.display = 'none';
        document.getElementById('compareNoData').style.display = 'none';

        fetch(`/history/${historyId}/schema-compare/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('compareLoading').style.display = 'none';

                if (data.error) {
                    document.getElementById('compareError').textContent = data.error;
                    document.getElementById('compareError').style.display = 'block';
                    return;
                }

                if (!data.has_versions) {
                    document.getElementById('compareNoData').style.display = 'block';
                    return;
                }

                // Populate data
                document.getElementById('compareTableName').textContent = data.table_name || '알 수 없음';
                document.getElementById('compareExecutedAt').textContent = data.executed_at || '';
                document.getElementById('compareQuery').textContent = data.query_text ? (data.query_text.length > 50 ? data.query_text.substring(0, 50) + '...' : data.query_text) : '';
                document.getElementById('compareQuery').title = data.query_text || '';

                // 스키마 상태에 따른 메시지
                const beforeSchema = data.before_schema || '';
                const afterSchema = data.after_schema || '';

                if (!beforeSchema && afterSchema) {
                    // CREATE TABLE인 경우
                    document.getElementById('schemaBefore').innerHTML = '<span class="text-muted">(테이블 생성 전 - 스키마 없음)</span>';
                } else if (beforeSchema && !afterSchema) {
                    // DROP TABLE인 경우
                    document.getElementById('schemaBefore').textContent = beforeSchema;
                } else {
                    document.getElementById('schemaBefore').textContent = beforeSchema || '(스키마 조회 실패)';
                }

                if (afterSchema) {
                    document.getElementById('schemaAfter').textContent = afterSchema;
                } else if (beforeSchema) {
                    // DROP TABLE인 경우
                    document.getElementById('schemaAfter').innerHTML = '<span class="text-muted">(테이블 삭제됨 - 스키마 없음)</span>';
                } else {
                    document.getElementById('schemaAfter').textContent = '(스키마 조회 실패)';
                }

                // Format diff with colors
                if (data.diff_lines && data.diff_lines.length > 0) {
                    const diffHtml = data.diff_lines.map(line => {
                        if (line.startsWith('+')) {
                            return `<span class="diff-added">${escapeHtml(line)}</span>`;
                        } else if (line.startsWith('-')) {
                            return `<span class="diff-removed">${escapeHtml(line)}</span>`;
                        } else if (line.startsWith('@@')) {
                            return `<span class="text-info">${escapeHtml(line)}</span>`;
                        } else {
                            return `<span class="diff-context">${escapeHtml(line)}</span>`;
                        }
                    }).join('\n');
                    document.getElementById('schemaDiff').innerHTML = diffHtml;
                } else {
                    document.getElementById('schemaDiff').textContent = '(변경 사항 없음)';
                }

                document.getElementById('compareContent').style.display = 'block';

                // Reset to first tab (비교 보기)
                const firstTab = document.querySelector('#schemaCompareModal [data-bs-target="#tabSideBySide"]');
                if (firstTab) {
                    const tab = new bootstrap.Tab(firstTab);
                    tab.show();
                }
            })
            .catch(error => {
                document.getElementById('compareLoading').style.display = 'none';
                document.getElementById('compareError').textContent = '비교 데이터를 불러오는 중 오류가 발생했습니다.';
                document.getElementById('compareError').style.display = 'block';
                console.error('Schema compare error:', error);
            });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
});
</script>
{% endblock %}
