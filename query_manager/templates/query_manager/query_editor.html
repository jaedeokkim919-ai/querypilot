{% extends 'query_manager/base.html' %}

{% block title %}쿼리 에디터 - QueryPilot{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/show-hint.min.css" rel="stylesheet">
<style>
    .CodeMirror {
        height: 300px;
        font-size: 14px;
    }
    .result-panel {
        max-height: 500px;
        overflow: auto;
    }
    .alter-suggestion {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
    }
    .diff-added { background-color: #d4edda; }
    .diff-removed { background-color: #f8d7da; }
    .copy-btn { cursor: pointer; }
    .copy-btn:hover { color: #0d6efd; }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-code-square"></i> 쿼리 에디터</h2>
    </div>
</div>

<!-- Connection Selector -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">DB 연결</label>
                <select id="connection-select" class="form-select">
                    <option value="">연결을 선택하세요...</option>
                    {% for conn in connections %}
                        <option value="{{ conn.pk }}"
                                data-host="{{ conn.host }}"
                                data-port="{{ conn.port }}"
                                data-database="{{ conn.database }}"
                                {% if selected_connection.pk == conn.pk %}selected{% endif %}>
                            {{ conn.name }} ({{ conn.host }}:{{ conn.port }}{% if conn.database %}/{{ conn.database }}{% endif %})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">데이터베이스</label>
                <select id="database-select" class="form-select" {% if not selected_connection %}disabled{% endif %}>
                    <option value="">선택...</option>
                    {% for db in databases %}
                        <option value="{{ db }}">{{ db }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2" id="table-dropdown-container" style="display: none;">
                <label class="form-label">테이블</label>
                <div class="input-group">
                    <select id="table-select" class="form-select">
                        <option value="">선택...</option>
                    </select>
                    <button type="button" id="btn-insert-table" class="btn btn-outline-secondary" title="에디터에 삽입">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">작업자 <span class="text-danger">*</span></label>
                <input type="text" id="operator-input" class="form-control" placeholder="작업자명" required>
            </div>
            <div class="col-md-2">
                <button type="button" id="btn-test-connection" class="btn btn-outline-secondary w-100" disabled>
                    <i class="bi bi-plug"></i> 연결 테스트
                </button>
            </div>
            <div class="col-md-1 text-end">
                <div id="connection-status"></div>
            </div>
        </div>
    </div>
</div>

<!-- Query Editor -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-code"></i> SQL 에디터</span>
        <div>
            <button type="button" id="btn-analyze" class="btn btn-sm btn-outline-info me-2" disabled>
                <i class="bi bi-lightbulb"></i> 온라인 DDL 분석
            </button>
            <button type="button" id="btn-review" class="btn btn-sm btn-warning me-2" disabled>
                <i class="bi bi-check2-square"></i> 검수
            </button>
            <button type="button" id="btn-execute" class="btn btn-sm btn-primary" disabled>
                <i class="bi bi-play-fill"></i> 실행
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <textarea id="sql-editor">-- SQL 쿼리를 입력하세요</textarea>
    </div>
</div>

<!-- Query Preview Panel (shown after review) -->
<div id="query-preview-panel" class="card mb-4 d-none">
    <div class="card-header bg-success bg-opacity-25 d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-check-circle"></i> 검수 완료 - 실행 대기</h6>
        <span id="query-count-badge" class="badge bg-primary"></span>
    </div>
    <div class="card-body" id="query-preview-content">
    </div>
</div>

<!-- ALTER Analysis Panel (hidden by default) -->
<div id="alter-analysis-panel" class="card mb-4 d-none">
    <div class="card-header bg-warning bg-opacity-25">
        <h6 class="mb-0"><i class="bi bi-lightbulb"></i> 온라인 DDL 분석</h6>
    </div>
    <div class="card-body" id="alter-analysis-content">
    </div>
</div>

<!-- Result Panel -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-table"></i> 실행 결과</span>
        <div id="result-stats" class="text-muted small"></div>
    </div>
    <div class="card-body p-0">
        <!-- DDL Result Tabs -->
        <ul class="nav nav-tabs d-none" id="ddl-result-tabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#tab-result">결과</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tab-before">BEFORE</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tab-after">AFTER</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tab-diff">DIFF</a>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-result">
                <div id="result-panel" class="result-panel">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-play-circle display-1"></i>
                        <p class="mt-3">쿼리를 실행하면 결과가 여기에 표시됩니다.</p>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="tab-before">
                <pre class="bg-light p-3 m-0" id="schema-before" style="max-height: 400px; overflow: auto;"></pre>
            </div>
            <div class="tab-pane fade" id="tab-after">
                <pre class="bg-light p-3 m-0" id="schema-after" style="max-height: 400px; overflow: auto;"></pre>
            </div>
            <div class="tab-pane fade" id="tab-diff">
                <div id="schema-diff" class="p-3" style="max-height: 400px; overflow: auto;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // CodeMirror 초기화
    const editor = CodeMirror.fromTextArea(document.getElementById('sql-editor'), {
        mode: 'text/x-mariadb',
        theme: 'dracula',
        lineNumbers: true,
        indentWithTabs: true,
        smartIndent: true,
        lineWrapping: true,
        matchBrackets: true,
        autofocus: true,
        extraKeys: {
            'Ctrl-Enter': executeQueries,
            'Ctrl-Space': 'autocomplete'
        },
        hintOptions: {
            completeSingle: false
        }
    });

    // 플레이스홀더 동작
    const placeholder = '-- SQL 쿼리를 입력하세요';
    editor.on('focus', function() {
        if (editor.getValue() === placeholder) {
            editor.setValue('');
        }
    });
    editor.on('blur', function() {
        if (editor.getValue().trim() === '') {
            editor.setValue(placeholder);
        }
    });

    const connectionSelect = document.getElementById('connection-select');
    const databaseSelect = document.getElementById('database-select');
    const tableSelect = document.getElementById('table-select');
    const tableDropdownContainer = document.getElementById('table-dropdown-container');
    const btnInsertTable = document.getElementById('btn-insert-table');
    const operatorInput = document.getElementById('operator-input');
    const btnTestConnection = document.getElementById('btn-test-connection');
    const btnAnalyze = document.getElementById('btn-analyze');
    const btnReview = document.getElementById('btn-review');
    const btnExecute = document.getElementById('btn-execute');
    const resultPanel = document.getElementById('result-panel');
    const resultStats = document.getElementById('result-stats');
    const connectionStatus = document.getElementById('connection-status');
    const alterAnalysisPanel = document.getElementById('alter-analysis-panel');
    const queryPreviewPanel = document.getElementById('query-preview-panel');
    const ddlResultTabs = document.getElementById('ddl-result-tabs');

    let validatedQueries = [];
    let currentOperator = '';

    // 연결 선택 시
    connectionSelect.addEventListener('change', function() {
        const connectionId = this.value;
        btnTestConnection.disabled = !connectionId;
        btnReview.disabled = !connectionId;
        btnAnalyze.disabled = !connectionId;
        databaseSelect.disabled = !connectionId;
        resetExecuteState();

        if (connectionId) {
            loadDatabases(connectionId);
        } else {
            databaseSelect.innerHTML = '<option value="">선택...</option>';
            tableDropdownContainer.style.display = 'none';
        }
    });

    // 데이터베이스 선택 시 테이블 로드
    databaseSelect.addEventListener('change', function() {
        const database = this.value;
        if (database && connectionSelect.value) {
            loadTables(connectionSelect.value, database);
        }
    });

    // 데이터베이스 목록 로드
    function loadDatabases(connectionId) {
        fetch(`/api/connections/${connectionId}/databases/`)
            .then(response => response.json())
            .then(data => {
                databaseSelect.innerHTML = '<option value="">선택...</option>';
                data.databases.forEach(db => {
                    const option = document.createElement('option');
                    option.value = db;
                    option.textContent = db;
                    databaseSelect.appendChild(option);
                });
            });
    }

    // 테이블 목록 로드
    function loadTables(connectionId, database) {
        fetch(`/api/connections/${connectionId}/databases/${database}/tables/`)
            .then(response => response.json())
            .then(data => {
                tableSelect.innerHTML = '<option value="">선택...</option>';
                data.tables.forEach(table => {
                    const option = document.createElement('option');
                    option.value = table;
                    option.textContent = table;
                    tableSelect.appendChild(option);
                });
                tableDropdownContainer.style.display = 'block';
            });
    }

    // 테이블 삽입
    btnInsertTable.addEventListener('click', function() {
        const tableName = tableSelect.value;
        if (tableName) {
            const cursor = editor.getCursor();
            editor.replaceRange(tableName, cursor);
            editor.focus();
        }
    });

    // 연결 테스트
    btnTestConnection.addEventListener('click', function() {
        const connectionId = connectionSelect.value;
        if (!connectionId) return;

        connectionStatus.innerHTML = '<span class="text-info"><i class="bi bi-hourglass-split"></i></span>';

        fetch(`/api/connections/${connectionId}/test/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                connectionStatus.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i></span>`;
            } else {
                connectionStatus.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i></span>`;
            }
        });
    });

    // 온라인 DDL 분석
    btnAnalyze.addEventListener('click', function() {
        const connectionId = connectionSelect.value;
        const query = editor.getValue().trim();

        if (!connectionId || !query || query === placeholder) return;

        fetch('/query/analyze-alter/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                connection_id: connectionId,
                query: query
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.is_alter) {
                showAlterAnalysis(data);
            } else {
                alert('ALTER 문이 아닙니다.');
            }
        });
    });

    // ALTER 분석 결과 표시 (개선된 UI)
    function showAlterAnalysis(data) {
        let html = `
            <p><strong>테이블:</strong> <code>${data.table_name}</code></p>
            <p><strong>작업:</strong> ${data.operation}</p>
            <p><strong>예상 영향:</strong> ${data.estimated_impact}</p>
            <h6 class="mt-3">최적화 옵션:</h6>
            <div class="list-group">
        `;

        data.suggestions.forEach((suggestion, idx) => {
            const combinedOption = suggestion.combined_option || `${suggestion.option}, ${suggestion.lock}`;
            const copyableQuery = data.copyable_queries ? data.copyable_queries[idx] : '';

            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong><code>${combinedOption}</code></strong>
                            <span class="copy-btn ms-2" onclick="copyToClipboard('${combinedOption}')" title="옵션 복사">
                                <i class="bi bi-clipboard"></i>
                            </span>
                        </div>
                        <span class="badge bg-${suggestion.impact === '매우 낮음' ? 'success' : suggestion.impact === '낮음' ? 'info' : suggestion.impact === '중간' ? 'warning' : 'danger'}">${suggestion.impact}</span>
                    </div>
                    <p class="mb-1 text-muted small">${suggestion.description}</p>
                    ${copyableQuery ? `
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard(\`${copyableQuery.replace(/`/g, '\\`')}\`)">
                                <i class="bi bi-clipboard"></i> 전체 쿼리 복사
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        });

        html += '</div>';

        document.getElementById('alter-analysis-content').innerHTML = html;
        alterAnalysisPanel.classList.remove('d-none');
    }

    // 검수 (Review)
    btnReview.addEventListener('click', function() {
        const connectionId = connectionSelect.value;
        const query = editor.getValue().trim();
        const operator = operatorInput.value.trim();

        if (!connectionId) {
            alert('연결을 선택해주세요.');
            return;
        }

        if (!query || query === placeholder) {
            alert('쿼리를 입력해주세요.');
            return;
        }

        if (!operator) {
            alert('작업자를 입력해주세요.');
            operatorInput.focus();
            return;
        }

        btnReview.disabled = true;
        btnReview.innerHTML = '<i class="bi bi-hourglass-split"></i> 검수 중...';

        fetch('/query/review/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                connection_id: connectionId,
                query: query,
                operator: operator
            })
        })
        .then(response => response.json())
        .then(data => {
            btnReview.disabled = false;
            btnReview.innerHTML = '<i class="bi bi-check2-square"></i> 검수';

            if (data.success) {
                showReviewResult(data);
            } else {
                alert('검수 실패: ' + data.error);
            }
        })
        .catch(error => {
            btnReview.disabled = false;
            btnReview.innerHTML = '<i class="bi bi-check2-square"></i> 검수';
            alert('검수 중 오류: ' + error.message);
        });
    });

    // 검수 결과 표시
    function showReviewResult(data) {
        validatedQueries = data.validation_results.map(r => r.full_query);
        currentOperator = data.operator;

        let html = '';
        data.validation_results.forEach((result, idx) => {
            const statusClass = result.valid ? 'success' : 'danger';
            const statusIcon = result.valid ? 'check-circle' : 'x-circle';

            html += `
                <div class="mb-3 p-3 border rounded ${result.is_dangerous ? 'border-warning' : ''}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="badge bg-secondary me-2">#${idx + 1}</span>
                            <span class="badge bg-${statusClass}"><i class="bi bi-${statusIcon}"></i> ${result.valid ? '유효' : '오류'}</span>
                            <span class="badge bg-info ms-1">${result.query_type}</span>
                        </div>
                    </div>
                    <pre class="bg-light p-2 mt-2 mb-2" style="max-height: 100px; overflow: auto;">${result.query}</pre>
                    ${result.errors.length > 0 ? `<div class="text-danger small">${result.errors.join('<br>')}</div>` : ''}
                    ${result.warnings.length > 0 ? `<div class="text-warning small">${result.warnings.join('<br>')}</div>` : ''}
                </div>
            `;
        });

        document.getElementById('query-preview-content').innerHTML = html;
        document.getElementById('query-count-badge').textContent = `${data.query_count}개 쿼리`;
        queryPreviewPanel.classList.remove('d-none');

        if (data.all_valid) {
            btnExecute.disabled = false;
            btnExecute.classList.remove('btn-secondary');
            btnExecute.classList.add('btn-primary');
        } else {
            btnExecute.disabled = true;
        }

        if (data.has_dangerous) {
            if (!confirm('위험한 쿼리가 포함되어 있습니다. 계속하시겠습니까?')) {
                resetExecuteState();
            }
        }
    }

    // 실행 상태 초기화
    function resetExecuteState() {
        validatedQueries = [];
        currentOperator = '';
        btnExecute.disabled = true;
        queryPreviewPanel.classList.add('d-none');
    }

    // 쿼리 실행
    function executeQueries() {
        if (validatedQueries.length === 0) {
            alert('먼저 검수를 진행해주세요.');
            return;
        }

        btnExecute.disabled = true;
        btnExecute.innerHTML = '<i class="bi bi-hourglass-split"></i> 실행 중...';
        resultStats.innerHTML = '';

        fetch('/query/batch-execute/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                connection_id: connectionSelect.value,
                queries: validatedQueries,
                operator: currentOperator
            })
        })
        .then(response => response.json())
        .then(data => {
            btnExecute.disabled = false;
            btnExecute.innerHTML = '<i class="bi bi-play-fill"></i> 실행';

            if (data.success) {
                showBatchResult(data);
            } else {
                showBatchError(data);
            }

            resetExecuteState();
        })
        .catch(error => {
            btnExecute.disabled = false;
            btnExecute.innerHTML = '<i class="bi bi-play-fill"></i> 실행';
            showError(error.message);
            resetExecuteState();
        });
    }

    btnExecute.addEventListener('click', executeQueries);

    // 배치 실행 결과 표시
    function showBatchResult(data) {
        resultStats.innerHTML = `
            <span class="text-success"><i class="bi bi-check-circle"></i> 성공</span>
            <span class="ms-3">총 ${data.total}개 쿼리</span>
            <span class="ms-3">성공: ${data.successful}</span>
            <span class="ms-3">배치 ID: ${data.batch_id}</span>
        `;

        let html = '<div class="p-3">';
        let hasDDL = false;
        let lastDDLResult = null;

        data.results.forEach((result, idx) => {
            const statusClass = result.success ? 'success' : 'danger';
            html += `
                <div class="alert alert-${statusClass} py-2">
                    <strong>#${idx + 1}</strong> ${result.query_type} -
                    영향받은 행: ${result.affected_rows},
                    실행 시간: ${result.execution_time.toFixed(3)}초
                </div>
            `;

            if (result.query_type === 'DDL' && (result.schema_before || result.schema_after)) {
                hasDDL = true;
                lastDDLResult = result;
            }
        });

        html += '</div>';
        resultPanel.innerHTML = html;

        // DDL 결과가 있으면 탭 표시
        if (hasDDL && lastDDLResult) {
            showDDLDiff(lastDDLResult.schema_before, lastDDLResult.schema_after);
        }
    }

    // 배치 실행 오류 표시
    function showBatchError(data) {
        resultStats.innerHTML = `
            <span class="text-danger"><i class="bi bi-x-circle"></i> 실패 (전체 롤백)</span>
            <span class="ms-3">배치 ID: ${data.batch_id}</span>
        `;

        let html = `
            <div class="p-3">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> <strong>오류:</strong> ${data.error}
                </div>
        `;

        if (data.results) {
            data.results.forEach((result, idx) => {
                const statusClass = result.success ? 'success' : 'danger';
                html += `
                    <div class="alert alert-${statusClass} py-2">
                        <strong>#${idx + 1}</strong> ${result.query_type} -
                        ${result.error ? result.error : '성공 (롤백됨)'}
                    </div>
                `;
            });
        }

        html += '</div>';
        resultPanel.innerHTML = html;
    }

    // DDL Diff 표시
    function showDDLDiff(before, after) {
        ddlResultTabs.classList.remove('d-none');

        document.getElementById('schema-before').textContent = before || '(없음)';
        document.getElementById('schema-after').textContent = after || '(없음)';

        // 간단한 diff 표시
        const diffDiv = document.getElementById('schema-diff');
        if (before && after) {
            const beforeLines = before.split('\n');
            const afterLines = after.split('\n');

            let diffHtml = '<pre>';
            const maxLen = Math.max(beforeLines.length, afterLines.length);

            for (let i = 0; i < maxLen; i++) {
                const bLine = beforeLines[i] || '';
                const aLine = afterLines[i] || '';

                if (bLine !== aLine) {
                    if (bLine && !afterLines.includes(bLine)) {
                        diffHtml += `<div class="diff-removed">- ${bLine}</div>`;
                    }
                    if (aLine && !beforeLines.includes(aLine)) {
                        diffHtml += `<div class="diff-added">+ ${aLine}</div>`;
                    }
                } else {
                    diffHtml += `<div>  ${aLine}</div>`;
                }
            }

            diffHtml += '</pre>';
            diffDiv.innerHTML = diffHtml;
        } else {
            diffDiv.innerHTML = '<p class="text-muted">비교할 스키마가 없습니다.</p>';
        }
    }

    // 에러 표시
    function showError(message) {
        resultStats.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> 실패</span>';
        resultPanel.innerHTML = `
            <div class="p-3">
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-exclamation-triangle"></i> <strong>오류:</strong> ${message}
                </div>
            </div>
        `;
    }

    // 초기 연결이 선택되어 있으면 버튼 활성화
    if (connectionSelect.value) {
        btnTestConnection.disabled = false;
        btnReview.disabled = false;
        btnAnalyze.disabled = false;
    }
});

// 클립보드 복사 함수
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // 복사 성공 알림 (선택적)
    }).catch(err => {
        console.error('복사 실패:', err);
    });
}
</script>
{% endblock %}
