{% extends 'query_manager/base.html' %}

{% block title %}쿼리 에디터 - QueryPilot{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/show-hint.min.css" rel="stylesheet">
<style>
    .CodeMirror {
        height: 300px;
        font-size: 14px;
    }
    .result-panel {
        max-height: 500px;
        overflow: auto;
    }
    .alter-suggestion {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-code-square"></i> 쿼리 에디터</h2>
    </div>
</div>

<!-- Connection Selector -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">DB 연결</label>
                <select id="connection-select" class="form-select">
                    <option value="">연결을 선택하세요...</option>
                    {% for conn in connections %}
                        <option value="{{ conn.pk }}"
                                data-host="{{ conn.host }}"
                                data-port="{{ conn.port }}"
                                data-database="{{ conn.database }}"
                                {% if selected_connection.pk == conn.pk %}selected{% endif %}>
                            {{ conn.name }} ({{ conn.host }}:{{ conn.port }}{% if conn.database %}/{{ conn.database }}{% endif %})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">데이터베이스</label>
                <select id="database-select" class="form-select" {% if not selected_connection %}disabled{% endif %}>
                    <option value="">선택...</option>
                    {% for db in databases %}
                        <option value="{{ db }}">{{ db }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="button" id="btn-test-connection" class="btn btn-outline-secondary w-100" disabled>
                    <i class="bi bi-plug"></i> 연결 테스트
                </button>
            </div>
            <div class="col-md-3 text-end">
                <div id="connection-status"></div>
            </div>
        </div>
    </div>
</div>

<!-- Query Editor -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-code"></i> SQL 에디터</span>
        <div>
            <button type="button" id="btn-analyze" class="btn btn-sm btn-outline-info me-2" disabled>
                <i class="bi bi-lightbulb"></i> ALTER 분석
            </button>
            <button type="button" id="btn-execute" class="btn btn-sm btn-primary" disabled>
                <i class="bi bi-play-fill"></i> 실행 (Ctrl+Enter)
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <textarea id="sql-editor">{% if query %}{{ query }}{% else %}-- SQL 쿼리를 입력하세요
SELECT * FROM {% endif %}</textarea>
    </div>
</div>

<!-- ALTER Analysis Panel (hidden by default) -->
<div id="alter-analysis-panel" class="card mb-4 d-none">
    <div class="card-header bg-warning bg-opacity-25">
        <h6 class="mb-0"><i class="bi bi-lightbulb"></i> ALTER 문 최적화 제안</h6>
    </div>
    <div class="card-body" id="alter-analysis-content">
    </div>
</div>

<!-- Result Panel -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-table"></i> 실행 결과</span>
        <div id="result-stats" class="text-muted small"></div>
    </div>
    <div class="card-body p-0">
        <div id="result-panel" class="result-panel">
            <div class="text-center text-muted py-5">
                <i class="bi bi-play-circle display-1"></i>
                <p class="mt-3">쿼리를 실행하면 결과가 여기에 표시됩니다.</p>
            </div>
        </div>
    </div>
</div>

<!-- Schema Diff Modal -->
<div class="modal fade" id="schemaDiffModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-diff"></i> 스키마 변경 내역</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>실행 전</h6>
                        <pre class="bg-light p-3" id="schema-before"></pre>
                    </div>
                    <div class="col-md-6">
                        <h6>실행 후</h6>
                        <pre class="bg-light p-3" id="schema-after"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // CodeMirror 초기화
    const editor = CodeMirror.fromTextArea(document.getElementById('sql-editor'), {
        mode: 'text/x-mariadb',
        theme: 'dracula',
        lineNumbers: true,
        indentWithTabs: true,
        smartIndent: true,
        lineWrapping: true,
        matchBrackets: true,
        autofocus: true,
        extraKeys: {
            'Ctrl-Enter': executeQuery,
            'Ctrl-Space': 'autocomplete'
        },
        hintOptions: {
            completeSingle: false
        }
    });

    const connectionSelect = document.getElementById('connection-select');
    const databaseSelect = document.getElementById('database-select');
    const btnTestConnection = document.getElementById('btn-test-connection');
    const btnAnalyze = document.getElementById('btn-analyze');
    const btnExecute = document.getElementById('btn-execute');
    const resultPanel = document.getElementById('result-panel');
    const resultStats = document.getElementById('result-stats');
    const connectionStatus = document.getElementById('connection-status');
    const alterAnalysisPanel = document.getElementById('alter-analysis-panel');

    // 연결 선택 시
    connectionSelect.addEventListener('change', function() {
        const connectionId = this.value;
        btnTestConnection.disabled = !connectionId;
        btnExecute.disabled = !connectionId;
        btnAnalyze.disabled = !connectionId;
        databaseSelect.disabled = !connectionId;

        if (connectionId) {
            loadDatabases(connectionId);
        } else {
            databaseSelect.innerHTML = '<option value="">선택...</option>';
        }
    });

    // 데이터베이스 목록 로드
    function loadDatabases(connectionId) {
        fetch(`/api/connections/${connectionId}/databases/`)
            .then(response => response.json())
            .then(data => {
                databaseSelect.innerHTML = '<option value="">선택...</option>';
                data.databases.forEach(db => {
                    const option = document.createElement('option');
                    option.value = db;
                    option.textContent = db;
                    databaseSelect.appendChild(option);
                });
            });
    }

    // 연결 테스트
    btnTestConnection.addEventListener('click', function() {
        const connectionId = connectionSelect.value;
        if (!connectionId) return;

        connectionStatus.innerHTML = '<span class="text-info"><i class="bi bi-hourglass-split"></i> 테스트 중...</span>';

        fetch(`/api/connections/${connectionId}/test/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                connectionStatus.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> 연결 성공 (${data.server_info.version})</span>`;
            } else {
                connectionStatus.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${data.message}</span>`;
            }
        });
    });

    // ALTER 분석
    btnAnalyze.addEventListener('click', function() {
        const connectionId = connectionSelect.value;
        const query = editor.getValue().trim();

        if (!connectionId || !query) return;

        fetch('/query/analyze-alter/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                connection_id: connectionId,
                query: query
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.is_alter) {
                showAlterAnalysis(data);
            } else {
                alert('ALTER 문이 아닙니다.');
            }
        });
    });

    // ALTER 분석 결과 표시
    function showAlterAnalysis(data) {
        let html = `
            <p><strong>테이블:</strong> ${data.table_name}</p>
            <p><strong>작업:</strong> ${data.operation}</p>
            <p><strong>예상 영향:</strong> ${data.estimated_impact}</p>
            <h6 class="mt-3">최적화 옵션:</h6>
            <div class="list-group">
        `;

        data.suggestions.forEach(suggestion => {
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong><code>${suggestion.option}</code></strong>
                        <span class="badge bg-${suggestion.impact === '매우 낮음' ? 'success' : suggestion.impact === '낮음' ? 'info' : suggestion.impact === '중간' ? 'warning' : 'danger'}">${suggestion.impact}</span>
                    </div>
                    <p class="mb-1 text-muted small">${suggestion.description}</p>
                    <small>Lock: <code>${suggestion.lock}</code></small>
                </div>
            `;
        });

        html += '</div>';

        document.getElementById('alter-analysis-content').innerHTML = html;
        alterAnalysisPanel.classList.remove('d-none');
    }

    // 쿼리 실행
    function executeQuery() {
        const connectionId = connectionSelect.value;
        const query = editor.getValue().trim();

        if (!connectionId) {
            alert('연결을 선택해주세요.');
            return;
        }

        if (!query) {
            alert('쿼리를 입력해주세요.');
            return;
        }

        btnExecute.disabled = true;
        btnExecute.innerHTML = '<i class="bi bi-hourglass-split"></i> 실행 중...';
        resultStats.innerHTML = '';

        fetch('/query/execute/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                connection_id: connectionId,
                query: query
            })
        })
        .then(response => response.json())
        .then(data => {
            btnExecute.disabled = false;
            btnExecute.innerHTML = '<i class="bi bi-play-fill"></i> 실행 (Ctrl+Enter)';

            if (data.success) {
                showResult(data);
            } else {
                showError(data.error);
            }
        })
        .catch(error => {
            btnExecute.disabled = false;
            btnExecute.innerHTML = '<i class="bi bi-play-fill"></i> 실행 (Ctrl+Enter)';
            showError(error.message);
        });
    }

    btnExecute.addEventListener('click', executeQuery);

    // 결과 표시
    function showResult(data) {
        resultStats.innerHTML = `
            <span class="text-success"><i class="bi bi-check-circle"></i> 성공</span>
            <span class="ms-3">영향받은 행: ${data.affected_rows}</span>
            <span class="ms-3">실행 시간: ${data.execution_time.toFixed(3)}초</span>
        `;

        if (data.query_type === 'SELECT' && data.data && data.data.length > 0) {
            // SELECT 결과 테이블
            let html = '<div class="table-responsive"><table class="table table-sm table-striped table-hover mb-0">';
            html += '<thead class="table-dark"><tr>';
            data.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';

            data.data.forEach(row => {
                html += '<tr>';
                data.columns.forEach(col => {
                    const value = row[col];
                    html += `<td>${value !== null ? value : '<span class="text-muted">NULL</span>'}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            resultPanel.innerHTML = html;
        } else if (data.query_type === 'DDL' && (data.schema_before || data.schema_after)) {
            // DDL 결과 + 스키마 변경
            let html = `
                <div class="p-3">
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> DDL 실행 완료
                    </div>
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#schemaDiffModal">
                        <i class="bi bi-file-diff"></i> 스키마 변경 보기
                    </button>
                </div>
            `;
            resultPanel.innerHTML = html;

            document.getElementById('schema-before').textContent = data.schema_before || '(없음)';
            document.getElementById('schema-after').textContent = data.schema_after || '(없음)';
        } else {
            // DML 결과
            resultPanel.innerHTML = `
                <div class="p-3">
                    <div class="alert alert-success mb-0">
                        <i class="bi bi-check-circle"></i> 쿼리 실행 완료 (영향받은 행: ${data.affected_rows})
                    </div>
                </div>
            `;
        }

        // ALTER 분석 결과가 있으면 표시
        if (data.alter_analysis && data.alter_analysis.is_alter) {
            showAlterAnalysis(data.alter_analysis);
        }
    }

    // 에러 표시
    function showError(message) {
        resultStats.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> 실패</span>';
        resultPanel.innerHTML = `
            <div class="p-3">
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-exclamation-triangle"></i> <strong>오류:</strong> ${message}
                </div>
            </div>
        `;
    }

    // 초기 연결이 선택되어 있으면 버튼 활성화
    if (connectionSelect.value) {
        btnTestConnection.disabled = false;
        btnExecute.disabled = false;
        btnAnalyze.disabled = false;
    }
});
</script>
{% endblock %}
