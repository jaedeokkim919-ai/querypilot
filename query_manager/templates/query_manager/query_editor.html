{% extends 'query_manager/base.html' %}

{% block title %}쿼리 에디터 - QueryPilot{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/hint/show-hint.min.css" rel="stylesheet">
<style>
    .CodeMirror {
        height: 300px;
        font-size: 14px;
    }
    .result-panel {
        max-height: 500px;
        overflow: auto;
    }
    .diff-added { background-color: #d4edda; }
    .diff-removed { background-color: #f8d7da; }
    .copy-btn { cursor: pointer; }
    .copy-btn:hover { color: #0d6efd; }
    .section-card {
        border-left: 3px solid #0d6efd;
    }
    .section-card.section-connection { border-left-color: #6c757d; }
    .section-card.section-editor { border-left-color: #0d6efd; }
    .section-card.section-confirmation { border-left-color: #198754; }
    .section-card.section-result { border-left-color: #ffc107; }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-code-square"></i> 쿼리 에디터</h2>
    </div>
</div>

<!-- ============ 섹션 1: DB 연결 ============ -->
<div class="card mb-4 section-card section-connection" id="section-connection">
    <div class="card-header">
        <i class="bi bi-plug"></i> DB 연결
    </div>
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">DB 연결</label>
                <select id="connection-select" class="form-select">
                    <option value="">연결을 선택하세요...</option>
                    {% for conn in connections %}
                        <option value="{{ conn.pk }}"
                                data-host="{{ conn.host }}"
                                data-port="{{ conn.port }}"
                                data-database="{{ conn.database }}"
                                {% if selected_connection.pk == conn.pk %}selected{% endif %}>
                            {{ conn.name }} ({{ conn.host }}:{{ conn.port }}{% if conn.database %}/{{ conn.database }}{% endif %})
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">데이터베이스</label>
                <div class="input-group">
                    <select id="database-select" class="form-select" {% if not selected_connection %}disabled{% endif %}>
                        <option value="">선택...</option>
                        {% for db in databases %}
                            <option value="{{ db }}">{{ db }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" id="btn-insert-database" class="btn btn-outline-secondary" title="에디터에 삽입">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-2" id="table-dropdown-container" style="display: none;">
                <label class="form-label">테이블</label>
                <div class="input-group">
                    <select id="table-select" class="form-select">
                        <option value="">선택...</option>
                    </select>
                    <button type="button" id="btn-insert-table" class="btn btn-outline-secondary" title="에디터에 삽입">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <button type="button" id="btn-test-connection" class="btn btn-outline-secondary w-100" disabled title="연결 테스트">
                    <i class="bi bi-plug"></i> 연결 확인
                </button>
            </div>
            <div class="col-md-3">
                <div id="connection-status" class="small"></div>
            </div>
        </div>
    </div>
</div>

<!-- ============ 섹션 2: SQL 에디터 ============ -->
<div class="card mb-4 section-card section-editor" id="section-editor">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-code"></i> SQL 에디터</span>
        <div>
            <button type="button" id="btn-analyze" class="btn btn-sm btn-outline-info me-2" disabled>
                <i class="bi bi-lightbulb"></i> 온라인 DDL 분석
            </button>
            <button type="button" id="btn-review" class="btn btn-sm btn-warning" disabled>
                <i class="bi bi-check2-square"></i> 검수
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <textarea id="sql-editor">-- SQL 쿼리를 입력하세요</textarea>
    </div>
</div>

<!-- ALTER Analysis Panel (에디터 섹션 하단에 표시) -->
<div id="alter-analysis-panel" class="card mb-4 d-none">
    <div class="card-header bg-warning bg-opacity-25">
        <h6 class="mb-0"><i class="bi bi-lightbulb"></i> 온라인 DDL 분석</h6>
    </div>
    <div class="card-body" id="alter-analysis-content">
    </div>
</div>

<!-- ============ 섹션 3: 실행 전 확인 ============ -->
<div class="card mb-4 section-card section-confirmation d-none" id="section-confirmation">
    <div class="card-header bg-success bg-opacity-10">
        <i class="bi bi-check-circle"></i> 실행될 SQL 구문
        <span id="query-count-badge" class="badge bg-primary ms-2"></span>
    </div>
    <div class="card-body">
        <!-- 검증된 쿼리 목록 -->
        <div id="query-preview-content" class="mb-4">
        </div>

        <!-- 구분선 -->
        <hr>

        <!-- 작업자 입력 및 실행 버튼 -->
        <div class="row align-items-end">
            <div class="col-md-4">
                <label class="form-label">작업자 <span class="text-danger">*</span></label>
                <input type="text" id="operator-input" class="form-control" placeholder="작업자명" required>
                <small class="text-muted">쿼리 실행자 이름을 입력하세요</small>
            </div>
            <div class="col-md-4">
                <button type="button" id="btn-execute" class="btn btn-success btn-lg" disabled>
                    <i class="bi bi-play-fill"></i> 실행
                </button>
                <button type="button" id="btn-cancel-execution" class="btn btn-outline-secondary btn-lg ms-2">
                    <i class="bi bi-x-lg"></i> 취소
                </button>
            </div>
            <div class="col-md-4">
                <div id="execution-warning" class="text-warning small d-none">
                    <i class="bi bi-exclamation-triangle"></i> 위험한 쿼리가 포함되어 있습니다.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ============ 섹션 4: 실행 결과 ============ -->
<div class="card section-card section-result" id="section-result">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-table"></i> 실행 결과</span>
        <div id="result-stats" class="text-muted small"></div>
    </div>
    <div class="card-body p-0">
        <!-- 다중 서버 결과 탭 -->
        <ul class="nav nav-tabs d-none" id="multi-server-tabs">
        </ul>
        <div class="tab-content" id="multi-server-tab-content">
        </div>

        <!-- 단일 서버 / DDL 결과 탭 -->
        <ul class="nav nav-tabs d-none" id="ddl-result-tabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#tab-result">결과</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tab-before">BEFORE</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tab-after">AFTER</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tab-diff">DIFF</a>
            </li>
        </ul>
        <div class="tab-content" id="single-server-content">
            <div class="tab-pane fade show active" id="tab-result">
                <div id="result-panel" class="result-panel">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-play-circle display-1"></i>
                        <p class="mt-3">쿼리를 실행하면 결과가 여기에 표시됩니다.</p>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="tab-before">
                <pre class="bg-light p-3 m-0" id="schema-before" style="max-height: 400px; overflow: auto;"></pre>
            </div>
            <div class="tab-pane fade" id="tab-after">
                <pre class="bg-light p-3 m-0" id="schema-after" style="max-height: 400px; overflow: auto;"></pre>
            </div>
            <div class="tab-pane fade" id="tab-diff">
                <div id="schema-diff" class="p-3" style="max-height: 400px; overflow: auto;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // CodeMirror 초기화
    const editor = CodeMirror.fromTextArea(document.getElementById('sql-editor'), {
        mode: 'text/x-mariadb',
        theme: 'dracula',
        lineNumbers: true,
        indentWithTabs: true,
        smartIndent: true,
        lineWrapping: true,
        matchBrackets: true,
        autofocus: true,
        extraKeys: {
            'Ctrl-Enter': executeQueries,
            'Ctrl-Space': 'autocomplete'
        },
        hintOptions: {
            completeSingle: false
        }
    });

    // 플레이스홀더 동작
    const placeholder = '-- SQL 쿼리를 입력하세요';
    let userHasTyped = false;

    editor.on('change', function() {
        const val = editor.getValue();
        if (val !== placeholder && val.trim() !== '') {
            userHasTyped = true;
        }
    });
    editor.on('focus', function() {
        if (editor.getValue() === placeholder) {
            editor.setValue('');
        }
    });
    editor.on('blur', function() {
        if (editor.getValue().trim() === '' && !userHasTyped) {
            editor.setValue(placeholder);
        }
    });

    // DOM 요소
    const connectionSelect = document.getElementById('connection-select');
    const databaseSelect = document.getElementById('database-select');
    const tableSelect = document.getElementById('table-select');
    const tableDropdownContainer = document.getElementById('table-dropdown-container');
    const btnInsertTable = document.getElementById('btn-insert-table');
    const btnInsertDatabase = document.getElementById('btn-insert-database');
    const operatorInput = document.getElementById('operator-input');
    const btnTestConnection = document.getElementById('btn-test-connection');
    const btnAnalyze = document.getElementById('btn-analyze');
    const btnReview = document.getElementById('btn-review');
    const btnExecute = document.getElementById('btn-execute');
    const btnCancelExecution = document.getElementById('btn-cancel-execution');
    const resultPanel = document.getElementById('result-panel');
    const resultStats = document.getElementById('result-stats');
    const connectionStatus = document.getElementById('connection-status');
    const alterAnalysisPanel = document.getElementById('alter-analysis-panel');
    const sectionConfirmation = document.getElementById('section-confirmation');
    const queryPreviewContent = document.getElementById('query-preview-content');
    const queryCountBadge = document.getElementById('query-count-badge');
    const executionWarning = document.getElementById('execution-warning');
    const ddlResultTabs = document.getElementById('ddl-result-tabs');
    const multiServerTabs = document.getElementById('multi-server-tabs');
    const multiServerTabContent = document.getElementById('multi-server-tab-content');
    const singleServerContent = document.getElementById('single-server-content');

    let validatedQueries = [];
    let currentOperator = '';

    // 연결 선택 시
    connectionSelect.addEventListener('change', function() {
        const connectionId = this.value;
        btnTestConnection.disabled = !connectionId;
        btnReview.disabled = !connectionId;
        btnAnalyze.disabled = !connectionId;
        databaseSelect.disabled = !connectionId;
        resetExecuteState();

        if (connectionId) {
            loadDatabases(connectionId);
        } else {
            databaseSelect.innerHTML = '<option value="">선택...</option>';
            tableDropdownContainer.style.display = 'none';
        }
    });

    // 데이터베이스 선택 시 테이블 로드
    databaseSelect.addEventListener('change', function() {
        const database = this.value;
        if (database && connectionSelect.value) {
            loadTables(connectionSelect.value, database);
        }
    });

    // 데이터베이스 목록 로드
    function loadDatabases(connectionId) {
        fetch(`/api/connections/${connectionId}/databases/`)
            .then(response => response.json())
            .then(data => {
                databaseSelect.innerHTML = '<option value="">선택...</option>';
                data.databases.forEach(db => {
                    const option = document.createElement('option');
                    option.value = db;
                    option.textContent = db;
                    databaseSelect.appendChild(option);
                });
            });
    }

    // 테이블 목록 로드
    function loadTables(connectionId, database) {
        fetch(`/api/connections/${connectionId}/databases/${database}/tables/`)
            .then(response => response.json())
            .then(data => {
                tableSelect.innerHTML = '<option value="">선택...</option>';
                data.tables.forEach(table => {
                    const option = document.createElement('option');
                    option.value = table;
                    option.textContent = table;
                    tableSelect.appendChild(option);
                });
                tableDropdownContainer.style.display = 'block';
            });
    }

    // 테이블 삽입
    btnInsertTable.addEventListener('click', function() {
        const tableName = tableSelect.value;
        if (tableName) {
            if (editor.getValue() === placeholder) {
                editor.setValue('');
            }
            const cursor = editor.getCursor();
            editor.replaceRange(tableName, cursor);
            userHasTyped = true;
            editor.focus();
        }
    });

    // 데이터베이스 삽입
    btnInsertDatabase.addEventListener('click', function() {
        const dbName = databaseSelect.value;
        if (dbName) {
            if (editor.getValue() === placeholder) {
                editor.setValue('');
            }
            const cursor = editor.getCursor();
            editor.replaceRange(dbName, cursor);
            userHasTyped = true;
            editor.focus();
        }
    });

    // 연결 테스트
    btnTestConnection.addEventListener('click', function() {
        const connectionId = connectionSelect.value;
        if (!connectionId) return;

        connectionStatus.innerHTML = '<span class="text-info"><i class="bi bi-hourglass-split"></i> 테스트 중...</span>';

        fetch(`/api/connections/${connectionId}/test/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.is_multi_server) {
                // 다중 서버 결과 표시 (상세)
                let statusHtml = '';
                const successCount = data.successful_hosts || 0;
                const totalCount = data.total_hosts || 0;

                if (data.success) {
                    statusHtml = `<div class="text-success mb-2"><i class="bi bi-check-circle-fill"></i> <strong>연결 성공 (${successCount}/${totalCount})</strong></div>`;
                } else {
                    statusHtml = `<div class="text-warning mb-2"><i class="bi bi-exclamation-triangle-fill"></i> <strong>일부 연결 실패 (${successCount}/${totalCount})</strong></div>`;
                }

                statusHtml += '<div class="small">';
                data.results.forEach(r => {
                    if (r.success) {
                        statusHtml += `<div class="text-success mb-1">
                            <i class="bi bi-check-circle-fill"></i>
                            <strong>${r.hostname || '알 수 없음'}</strong>
                            <span class="text-muted">(${r.host})</span>
                        </div>`;
                    } else {
                        statusHtml += `<div class="text-danger mb-1">
                            <i class="bi bi-x-circle-fill"></i>
                            <strong>${r.host}</strong>
                            <span class="d-block text-muted ms-3" style="font-size: 0.85em;">오류: ${r.message || '연결 실패'}</span>
                        </div>`;
                    }
                });
                statusHtml += '</div>';
                connectionStatus.innerHTML = statusHtml;
            } else {
                // 단일 서버 결과 표시
                if (data.success) {
                    let statusHtml = `<span class="text-success"><i class="bi bi-check-circle-fill"></i> 연결 성공</span>`;
                    if (data.hostname) {
                        statusHtml += `<br><small class="text-muted"><i class="bi bi-server"></i> ${data.hostname}</small>`;
                    }
                    connectionStatus.innerHTML = statusHtml;
                } else {
                    connectionStatus.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle-fill"></i> 연결 실패: ${data.message || '알 수 없는 오류'}</span>`;
                }
            }
        });
    });

    // 온라인 DDL 분석
    btnAnalyze.addEventListener('click', function() {
        const connectionId = connectionSelect.value;
        const query = editor.getValue().trim();

        if (!connectionId || !query || query === placeholder) return;

        fetch('/query/analyze-alter/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                connection_id: connectionId,
                query: query
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.is_alter) {
                showAlterAnalysis(data);
            } else {
                alert('ALTER 문이 아닙니다.');
            }
        });
    });

    // ALTER 분석 결과 표시
    function showAlterAnalysis(data) {
        window.alterAnalysisCopyData = data.copyable_queries || [];

        let html = `
            <div class="mb-3">
                <span class="badge bg-secondary me-2">${data.table_name}</span>
                <span class="badge bg-info">${data.operation}</span>
            </div>
            <div class="list-group">
        `;

        data.suggestions.forEach((suggestion, idx) => {
            const combinedOption = suggestion.combined_option || `${suggestion.option}, ${suggestion.lock}`;
            const badgeClass = suggestion.impact === '매우 낮음' ? 'success' :
                              suggestion.impact === '낮음' ? 'info' :
                              suggestion.impact === '중간' ? 'warning' : 'danger';

            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                    <div class="d-flex align-items-center">
                        <code class="me-2 user-select-all">${combinedOption}</code>
                        <button type="button" class="btn btn-sm btn-outline-primary copy-query-btn"
                                data-copy-index="${idx}" title="쿼리 복사">
                            <i class="bi bi-clipboard"></i> 복사
                        </button>
                    </div>
                    <span class="badge bg-${badgeClass}">${suggestion.impact}</span>
                </div>
            `;
        });

        html += '</div>';

        document.getElementById('alter-analysis-content').innerHTML = html;
        alterAnalysisPanel.classList.remove('d-none');

        // 복사 버튼 이벤트 바인딩
        document.querySelectorAll('.copy-query-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const idx = parseInt(this.dataset.copyIndex);
                const queryToCopy = window.alterAnalysisCopyData[idx];
                if (queryToCopy) {
                    copyToClipboard(queryToCopy);
                }
            });
        });
    }

    // 검수 (Review)
    btnReview.addEventListener('click', function() {
        const connectionId = connectionSelect.value;
        const query = editor.getValue().trim();

        if (!connectionId) {
            alert('연결을 선택해주세요.');
            return;
        }

        if (!query || query === placeholder) {
            alert('쿼리를 입력해주세요.');
            return;
        }

        alterAnalysisPanel.classList.add('d-none');

        btnReview.disabled = true;
        btnReview.innerHTML = '<i class="bi bi-hourglass-split"></i> 검수 중...';

        fetch('/query/review/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                connection_id: connectionId,
                query: query,
                operator: operatorInput.value.trim() || 'pending'  // 임시값
            })
        })
        .then(response => response.json())
        .then(data => {
            btnReview.disabled = false;
            btnReview.innerHTML = '<i class="bi bi-check2-square"></i> 검수';

            if (data.success) {
                showReviewResult(data);
            } else {
                alert('검수 실패: ' + data.error);
            }
        })
        .catch(error => {
            btnReview.disabled = false;
            btnReview.innerHTML = '<i class="bi bi-check2-square"></i> 검수';
            alert('검수 중 오류: ' + error.message);
        });
    });

    // 검수 결과 표시 - 섹션 3 활성화
    function showReviewResult(data) {
        validatedQueries = data.validation_results.map(r => r.full_query);

        let html = '';
        data.validation_results.forEach((result, idx) => {
            const statusClass = result.valid ? 'success' : 'danger';
            const statusIcon = result.valid ? 'check-circle' : 'x-circle';

            html += `
                <div class="mb-3 p-3 border rounded ${result.is_dangerous ? 'border-warning' : ''}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="badge bg-secondary me-2">#${idx + 1}</span>
                            <span class="badge bg-${statusClass}"><i class="bi bi-${statusIcon}"></i> ${result.valid ? '유효' : '오류'}</span>
                            <span class="badge bg-info ms-1">${result.query_type}</span>
                        </div>
                    </div>
                    <pre class="bg-light p-2 mt-2 mb-2" style="max-height: 100px; overflow: auto;">${result.query}</pre>
                    ${result.errors.length > 0 ? `<div class="text-danger small">${result.errors.join('<br>')}</div>` : ''}
                    ${result.warnings.length > 0 ? `<div class="text-warning small">${result.warnings.join('<br>')}</div>` : ''}
                </div>
            `;
        });

        queryPreviewContent.innerHTML = html;
        queryCountBadge.textContent = `${data.query_count}개 쿼리`;

        // 섹션 3 표시
        sectionConfirmation.classList.remove('d-none');

        // 작업자 입력 시 실행 버튼 활성화
        updateExecuteButtonState(data.all_valid);

        // 위험한 쿼리 경고
        if (data.has_dangerous) {
            executionWarning.classList.remove('d-none');
        } else {
            executionWarning.classList.add('d-none');
        }

        // 섹션 3으로 스크롤
        sectionConfirmation.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // 작업자 입력 시 실행 버튼 상태 업데이트
    operatorInput.addEventListener('input', function() {
        updateExecuteButtonState(validatedQueries.length > 0);
    });

    function updateExecuteButtonState(allValid) {
        const hasOperator = operatorInput.value.trim().length > 0;
        btnExecute.disabled = !(allValid && hasOperator);
    }

    // 실행 취소
    btnCancelExecution.addEventListener('click', function() {
        resetExecuteState();
    });

    // 실행 상태 초기화
    function resetExecuteState() {
        validatedQueries = [];
        currentOperator = '';
        btnExecute.disabled = true;
        sectionConfirmation.classList.add('d-none');
        executionWarning.classList.add('d-none');
    }

    // 쿼리 실행
    function executeQueries() {
        if (validatedQueries.length === 0) {
            alert('먼저 검수를 진행해주세요.');
            return;
        }

        const operator = operatorInput.value.trim();
        if (!operator) {
            alert('작업자를 입력해주세요.');
            operatorInput.focus();
            return;
        }

        currentOperator = operator;
        alterAnalysisPanel.classList.add('d-none');

        btnExecute.disabled = true;
        btnExecute.innerHTML = '<i class="bi bi-hourglass-split"></i> 실행 중...';
        resultStats.innerHTML = '';

        fetch('/query/batch-execute/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                connection_id: connectionSelect.value,
                queries: validatedQueries,
                operator: currentOperator
            })
        })
        .then(response => response.json())
        .then(data => {
            btnExecute.disabled = false;
            btnExecute.innerHTML = '<i class="bi bi-play-fill"></i> 실행';

            if (data.success) {
                showBatchResult(data);
            } else {
                showBatchError(data);
            }

            resetExecuteState();

            // 결과 섹션으로 스크롤
            document.getElementById('section-result').scrollIntoView({ behavior: 'smooth', block: 'start' });
        })
        .catch(error => {
            btnExecute.disabled = false;
            btnExecute.innerHTML = '<i class="bi bi-play-fill"></i> 실행';
            showError(error.message);
            resetExecuteState();
        });
    }

    btnExecute.addEventListener('click', executeQueries);

    // 배치 실행 결과 표시
    function showBatchResult(data) {
        // 다중 서버 결과 처리
        if (data.is_multi_server && data.results) {
            showMultiServerResult(data);
            return;
        }

        // 단일 서버 결과 표시
        multiServerTabs.classList.add('d-none');
        multiServerTabContent.innerHTML = '';
        singleServerContent.style.display = 'block';

        resultStats.innerHTML = `
            <span class="text-success"><i class="bi bi-check-circle"></i> 성공</span>
            <span class="ms-3">총 ${data.total}개 쿼리</span>
            <span class="ms-3">성공: ${data.successful}</span>
            <span class="ms-3">배치 ID: ${data.batch_id}</span>
        `;

        let html = '<div class="p-3">';
        let hasDDL = false;
        let lastDDLResult = null;

        data.results.forEach((result, idx) => {
            const statusClass = result.success ? 'success' : 'danger';

            // 디버깅: 결과 데이터 확인
            console.log('Query result:', idx, result);

            // SELECT 쿼리인 경우
            if (result.query_type === 'SELECT') {
                const rowCount = result.data ? result.data.length : 0;
                html += `
                    <div class="alert alert-${statusClass} py-2">
                        <strong>#${idx + 1}</strong> ${result.query_type} -
                        ${rowCount}행 조회,
                        실행 시간: ${result.execution_time.toFixed(3)}초
                    </div>
                `;
                // 데이터가 있으면 테이블 표시
                if (result.data && result.data.length > 0) {
                    html += renderDataTable(result.data, result.columns);
                } else if (result.columns && result.columns.length > 0) {
                    // 데이터는 없지만 컬럼 정보가 있으면 빈 테이블 헤더 표시
                    html += `<div class="text-muted small p-2"><i class="bi bi-info-circle"></i> 조회된 데이터가 없습니다. (컬럼: ${result.columns.join(', ')})</div>`;
                }
            } else {
                // DML/DDL 쿼리
                html += `
                    <div class="alert alert-${statusClass} py-2">
                        <strong>#${idx + 1}</strong> ${result.query_type} -
                        영향받은 행: ${result.affected_rows},
                        실행 시간: ${result.execution_time.toFixed(3)}초
                    </div>
                `;
            }

            if (result.query_type === 'DDL' && (result.schema_before || result.schema_after)) {
                hasDDL = true;
                lastDDLResult = result;
            }
        });

        html += '</div>';
        resultPanel.innerHTML = html;

        if (hasDDL && lastDDLResult) {
            showDDLDiff(lastDDLResult.schema_before, lastDDLResult.schema_after);
        }
    }

    // 다중 서버 결과 표시
    function showMultiServerResult(data) {
        // 단일 서버 결과 영역 숨기기
        singleServerContent.style.display = 'none';
        ddlResultTabs.classList.add('d-none');

        // 결과 통계
        resultStats.innerHTML = `
            <span class="${data.failed_hosts === 0 ? 'text-success' : 'text-warning'}">
                <i class="bi bi-${data.failed_hosts === 0 ? 'check-circle' : 'exclamation-triangle'}"></i>
                ${data.successful_hosts}/${data.total_hosts} 서버 성공
            </span>
        `;

        // 탭 생성
        let tabsHtml = '';
        let contentHtml = '';

        data.results.forEach((serverResult, idx) => {
            const isActive = idx === 0 ? 'active' : '';
            const statusIcon = serverResult.success ? 'check-circle text-success' : 'x-circle text-danger';
            const serverName = serverResult.hostname || serverResult.host;

            tabsHtml += `
                <li class="nav-item">
                    <a class="nav-link ${isActive}" data-bs-toggle="tab" href="#server-tab-${idx}">
                        <i class="bi bi-${statusIcon}"></i>
                        ${serverName}
                    </a>
                </li>
            `;

            contentHtml += `
                <div class="tab-pane fade ${idx === 0 ? 'show active' : ''}" id="server-tab-${idx}">
                    <div class="p-3">
                        ${renderServerResult(serverResult)}
                    </div>
                </div>
            `;
        });

        multiServerTabs.innerHTML = tabsHtml;
        multiServerTabContent.innerHTML = contentHtml;
        multiServerTabs.classList.remove('d-none');
    }

    // 개별 서버 결과 렌더링
    function renderServerResult(serverResult) {
        let html = '';

        // 디버깅: 서버 결과 확인
        console.log('Server result:', serverResult);

        if (serverResult.success) {
            const statusClass = 'success';

            // SELECT 쿼리인 경우
            if (serverResult.query_type === 'SELECT') {
                const rowCount = serverResult.data ? serverResult.data.length : 0;
                html += `
                    <div class="alert alert-${statusClass} py-2">
                        <i class="bi bi-check-circle"></i> ${serverResult.query_type} -
                        ${rowCount}행 조회,
                        실행 시간: ${serverResult.execution_time.toFixed(3)}초
                    </div>
                `;
                if (rowCount > 0) {
                    html += renderDataTable(serverResult.data, serverResult.columns);
                } else if (serverResult.columns && serverResult.columns.length > 0) {
                    html += `<div class="text-muted small p-2"><i class="bi bi-info-circle"></i> 조회된 데이터가 없습니다. (컬럼: ${serverResult.columns.join(', ')})</div>`;
                }
            } else {
                // DML/DDL 쿼리
                html += `
                    <div class="alert alert-${statusClass} py-2">
                        <i class="bi bi-check-circle"></i> ${serverResult.query_type} -
                        영향받은 행: ${serverResult.affected_rows},
                        실행 시간: ${serverResult.execution_time.toFixed(3)}초
                    </div>
                `;
            }

            // DDL 스키마 비교
            if (serverResult.query_type === 'DDL' && (serverResult.schema_before || serverResult.schema_after)) {
                html += `
                    <div class="mt-3">
                        <ul class="nav nav-tabs" id="ddl-tabs-${serverResult.host}">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#before-${serverResult.host}">BEFORE</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#after-${serverResult.host}">AFTER</a>
                            </li>
                        </ul>
                        <div class="tab-content border border-top-0 p-2">
                            <div class="tab-pane fade show active" id="before-${serverResult.host}">
                                <pre class="bg-light p-2 m-0 small" style="max-height: 200px; overflow: auto;">${serverResult.schema_before || '(없음)'}</pre>
                            </div>
                            <div class="tab-pane fade" id="after-${serverResult.host}">
                                <pre class="bg-light p-2 m-0 small" style="max-height: 200px; overflow: auto;">${serverResult.schema_after || '(없음)'}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }
        } else {
            html += `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> <strong>실패:</strong> ${serverResult.error}
                </div>
            `;
        }

        return html;
    }

    // SELECT 결과 테이블 렌더링
    function renderDataTable(data, columns) {
        if (!data || data.length === 0) return '';

        const cols = columns || Object.keys(data[0]);

        let html = '<div class="table-responsive mb-3" style="max-height: 300px; overflow: auto;">';
        html += '<table class="table table-sm table-bordered table-striped">';
        html += '<thead class="table-dark"><tr>';
        cols.forEach(col => {
            html += `<th>${col}</th>`;
        });
        html += '</tr></thead><tbody>';

        data.forEach(row => {
            html += '<tr>';
            cols.forEach(col => {
                const val = row[col];
                html += `<td>${val !== null && val !== undefined ? val : '<span class="text-muted">NULL</span>'}</td>`;
            });
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        return html;
    }

    // 배치 실행 오류 표시
    function showBatchError(data) {
        resultStats.innerHTML = `
            <span class="text-danger"><i class="bi bi-x-circle"></i> 실패 (전체 롤백)</span>
            <span class="ms-3">배치 ID: ${data.batch_id}</span>
        `;

        let html = `
            <div class="p-3">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> <strong>오류:</strong> ${data.error}
                </div>
        `;

        if (data.results) {
            data.results.forEach((result, idx) => {
                const statusClass = result.success ? 'success' : 'danger';
                html += `
                    <div class="alert alert-${statusClass} py-2">
                        <strong>#${idx + 1}</strong> ${result.query_type} -
                        ${result.error ? result.error : '성공 (롤백됨)'}
                    </div>
                `;
            });
        }

        html += '</div>';
        resultPanel.innerHTML = html;
    }

    // DDL Diff 표시
    function showDDLDiff(before, after) {
        ddlResultTabs.classList.remove('d-none');

        document.getElementById('schema-before').textContent = before || '(없음)';
        document.getElementById('schema-after').textContent = after || '(없음)';

        const diffDiv = document.getElementById('schema-diff');
        if (before && after) {
            const beforeLines = before.split('\n');
            const afterLines = after.split('\n');

            let diffHtml = '<pre>';
            const maxLen = Math.max(beforeLines.length, afterLines.length);

            for (let i = 0; i < maxLen; i++) {
                const bLine = beforeLines[i] || '';
                const aLine = afterLines[i] || '';

                if (bLine !== aLine) {
                    if (bLine && !afterLines.includes(bLine)) {
                        diffHtml += `<div class="diff-removed">- ${bLine}</div>`;
                    }
                    if (aLine && !beforeLines.includes(aLine)) {
                        diffHtml += `<div class="diff-added">+ ${aLine}</div>`;
                    }
                } else {
                    diffHtml += `<div>  ${aLine}</div>`;
                }
            }

            diffHtml += '</pre>';
            diffDiv.innerHTML = diffHtml;
        } else {
            diffDiv.innerHTML = '<p class="text-muted">비교할 스키마가 없습니다.</p>';
        }
    }

    // 에러 표시
    function showError(message) {
        resultStats.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> 실패</span>';
        resultPanel.innerHTML = `
            <div class="p-3">
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-exclamation-triangle"></i> <strong>오류:</strong> ${message}
                </div>
            </div>
        `;
    }

    // 초기 연결이 선택되어 있으면 버튼 활성화
    if (connectionSelect.value) {
        btnTestConnection.disabled = false;
        btnReview.disabled = false;
        btnAnalyze.disabled = false;
    }
});

// 클립보드 복사 함수
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('복사되었습니다');
    }).catch(err => {
        console.error('복사 실패:', err);
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showToast('복사되었습니다');
        } catch (e) {
            showToast('복사 실패', 'danger');
        }
        document.body.removeChild(textArea);
    });
}

// 토스트 메시지 표시 함수
function showToast(message, type = 'success') {
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }

    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
    toastEl.setAttribute('role', 'alert');
    toastEl.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    toastContainer.appendChild(toastEl);

    const toast = new bootstrap.Toast(toastEl, { delay: 2000 });
    toast.show();

    toastEl.addEventListener('hidden.bs.toast', () => {
        toastEl.remove();
    });
}
</script>
{% endblock %}
